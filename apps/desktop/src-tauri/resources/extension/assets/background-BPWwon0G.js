const c={PROFILES:"claudin_profiles",MESSAGES:"claudin_messages",POSTS:"claudin_posts",STATS:"claudin_stats"},m={AUTO_SYNC:"claudin_auto_sync",FEED_REFRESH:"claudin_feed_refresh",ENRICHMENT_CHECK:"claudin_enrichment_check"},C=5,w=15,T=1,S="http://localhost:3847/api",l=new Map,i=new Map,d=new Map;async function E(){const e=await chrome.storage.local.get([c.PROFILES,c.MESSAGES,c.POSTS]),n=e[c.PROFILES];n&&Object.entries(n).forEach(([f,a])=>{l.set(f,{...a,syncedAt:a.syncedAt??null})});const s=e[c.MESSAGES];s&&Object.entries(s).forEach(([f,a])=>{i.set(f,{...a,syncedAt:a.syncedAt??null})});const t=e[c.POSTS];t&&Object.entries(t).forEach(([f,a])=>{d.set(f,{...a,syncedAt:a.syncedAt??null})});const o=Array.from(l.values()).filter(f=>!f.syncedAt).length,u=Array.from(i.values()).filter(f=>!f.syncedAt).length,g=Array.from(d.values()).filter(f=>!f.syncedAt).length;console.log(`[ClaudIn] Initialized: ${l.size} profiles (${o} unsynced), ${i.size} messages (${u} unsynced), ${d.size} posts (${g} unsynced)`)}async function P(e){if(!e.publicIdentifier)return;const n=e.publicIdentifier,s=l.get(n),t={...s,...e,experience:e.isPartial&&(s!=null&&s.experience)?s.experience:e.experience||null,education:e.isPartial&&(s!=null&&s.education)?s.education:e.education||null,skills:e.isPartial&&(s!=null&&s.skills)?s.skills:e.skills||null,about:e.isPartial&&(s!=null&&s.about)?s.about:e.about||null,scrapedAt:e.scrapedAt||new Date().toISOString(),syncedAt:null};t.id||(t.id=`profile_${Date.now()}_${Math.random().toString(36).substring(2,9)}`),l.set(n,t);const o={};return l.forEach((u,g)=>{o[g]=u}),await chrome.storage.local.set({[c.PROFILES]:o}),await I(),t}async function I(){const e=Array.from(l.values()).filter(u=>!u.syncedAt).length,n=Array.from(i.values()).filter(u=>!u.syncedAt).length,s=Array.from(d.values()).filter(u=>!u.syncedAt).length,t=e+n+s,o={totalProfiles:l.size,totalMessages:i.size,totalPosts:d.size,unsyncedProfiles:e,unsyncedMessages:n,unsyncedPosts:s,lastSyncAt:new Date().toISOString()};await chrome.storage.local.set({[c.STATS]:o}),chrome.action.setBadgeText({text:t>0?t.toString():""}),chrome.action.setBadgeBackgroundColor({color:t>0?"#ef4444":"#0A66C2"})}async function v(e){const n={...e,syncedAt:null};i.set(e.id,n);const s={};return i.forEach((t,o)=>{s[o]=t}),await chrome.storage.local.set({[c.MESSAGES]:s}),await I(),n}async function O(e){const n={...e,syncedAt:null};d.set(e.id,n);const s={};return d.forEach((t,o)=>{s[o]=t}),await chrome.storage.local.set({[c.POSTS]:s}),await I(),n}chrome.runtime.onMessage.addListener((e,n,s)=>{switch(console.log("[ClaudIn] Received message:",e.type),e.type){case"profile":{P(e.data).then(o=>{console.log("[ClaudIn] Saved profile:",o==null?void 0:o.fullName)});break}case"search":{const t=e,{results:o}=t.data;Promise.all(o.map(P)).then(()=>{console.log(`[ClaudIn] Saved ${o.length} profiles from search`)});break}case"messages":{const t=e,{messages:o}=t.data;Promise.all(o.map(v)).then(()=>{console.log(`[ClaudIn] Saved ${o.length} messages`)});break}case"feed":{const t=e,{posts:o}=t.data;Promise.all(o.map(O)).then(()=>{console.log(`[ClaudIn] Saved ${o.length} posts`)});break}}return!0});var b;(b=chrome.runtime.onMessageExternal)==null||b.addListener((e,n,s)=>{switch(console.log("[ClaudIn] External message:",e),e.type){case"GET_PROFILES":{const t=Array.from(l.values());s({profiles:t});break}case"GET_STATS":return chrome.storage.local.get(c.STATS).then(t=>{s(t[c.STATS])}),!0;case"NAVIGATE":return chrome.tabs.query({active:!0,currentWindow:!0}).then(([t])=>{t!=null&&t.id&&(chrome.tabs.update(t.id,{url:e.url}),s({success:!0}))}),!0}});async function M(){await chrome.alarms.create(m.AUTO_SYNC,{delayInMinutes:1,periodInMinutes:C}),await chrome.alarms.create(m.FEED_REFRESH,{delayInMinutes:2,periodInMinutes:w}),await chrome.alarms.create(m.ENRICHMENT_CHECK,{delayInMinutes:.5,periodInMinutes:T}),console.log(`[ClaudIn] Alarms set: sync every ${C}min, feed refresh every ${w}min, enrichment check every ${T}min`)}async function R(){try{const e=await chrome.tabs.query({url:"https://www.linkedin.com/feed/*"});if(e.length===0)return console.log("[ClaudIn] No LinkedIn feed tab found, skipping refresh"),{refreshed:!1,reason:"no_feed_tab"};const n=e[0];return n.id?(await chrome.tabs.reload(n.id),console.log("[ClaudIn] Refreshed LinkedIn feed tab"),{refreshed:!0,tabId:n.id}):{refreshed:!1,reason:"no_tab_id"}}catch(e){return console.error("[ClaudIn] Feed refresh failed:",e),{refreshed:!1,reason:String(e)}}}let A=!1;async function $(){if(A){console.log("[ClaudIn] Enrichment already running, skipping");return}try{A=!0;const e=await fetch(`${S}/enrich/next`);if(!e.ok){console.log("[ClaudIn] Failed to fetch enrichment task");return}const{item:n}=await e.json();if(!n)return;console.log(`[ClaudIn] Processing enrichment: ${n.publicIdentifier}`);const s=await chrome.tabs.create({url:n.url,active:!1});if(!s.id){await _(n.publicIdentifier,!1,"Failed to create tab");return}await new Promise(t=>setTimeout(t,5e3));try{await chrome.tabs.sendMessage(s.id,{type:"FORCE_SCRAPE"})}catch{console.log("[ClaudIn] Could not send scrape message, page may still be loading")}await new Promise(t=>setTimeout(t,3e3)),await p();try{await chrome.tabs.remove(s.id)}catch{}await _(n.publicIdentifier,!0),console.log(`[ClaudIn] Enrichment completed: ${n.publicIdentifier}`)}catch(e){console.error("[ClaudIn] Enrichment error:",e)}finally{A=!1}}async function _(e,n,s){try{await fetch(`${S}/enrich/complete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({publicIdentifier:e,success:n,error:s})})}catch(t){console.error("[ClaudIn] Failed to mark enrichment complete:",t)}}chrome.alarms.onAlarm.addListener(async e=>{switch(console.log(`[ClaudIn] Alarm triggered: ${e.name}`),e.name){case m.AUTO_SYNC:{const n=await p();console.log("[ClaudIn] Auto-sync result:",n);break}case m.FEED_REFRESH:{const n=await R();console.log("[ClaudIn] Feed refresh result:",n);break}case m.ENRICHMENT_CHECK:{await $();break}}});chrome.runtime.onInstalled.addListener(()=>{console.log("[ClaudIn] Extension installed/updated"),E(),M()});chrome.runtime.onStartup.addListener(()=>{console.log("[ClaudIn] Extension started"),E(),M()});async function p(){try{const e=Array.from(l.values()).filter(a=>!a.syncedAt),n=Array.from(i.values()).filter(a=>!a.syncedAt),s=Array.from(d.values()).filter(a=>!a.syncedAt);console.log(`[ClaudIn] Syncing: ${e.length} profiles, ${n.length} messages, ${s.length} posts`);let t=0,o=0,u=0;const g=new Date().toISOString();if(e.length>0){const a=await fetch(`${S}/sync/profiles`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({profiles:e})});if(a.ok){const r=await a.json();if(t=r.saved,r.syncedIds&&Array.isArray(r.syncedIds))for(const h of r.syncedIds){const y=l.get(h);y&&(y.syncedAt=g,l.set(h,y))}r.failed&&r.failed.length>0&&console.warn(`[ClaudIn] ${r.failed.length} profiles failed to sync:`,r.failed)}}if(n.length>0){const a=await fetch(`${S}/sync/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:n})});if(a.ok){const r=await a.json();if(o=r.saved,r.syncedIds&&Array.isArray(r.syncedIds))for(const h of r.syncedIds){const y=i.get(h);y&&(y.syncedAt=g,i.set(h,y))}r.failed&&r.failed.length>0&&console.warn(`[ClaudIn] ${r.failed.length} messages failed to sync:`,r.failed)}}if(s.length>0){const a=await fetch(`${S}/sync/posts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({posts:s})});if(a.ok){const r=await a.json();if(u=r.saved,r.syncedIds&&Array.isArray(r.syncedIds))for(const h of r.syncedIds){const y=d.get(h);y&&(y.syncedAt=g,d.set(h,y))}r.failed&&r.failed.length>0&&console.warn(`[ClaudIn] ${r.failed.length} posts failed to sync:`,r.failed)}}await k();const f=Array.from(l.values()).filter(a=>!a.syncedAt).length+Array.from(i.values()).filter(a=>!a.syncedAt).length+Array.from(d.values()).filter(a=>!a.syncedAt).length;return console.log(`[ClaudIn] Synced ${t} profiles, ${o} messages, ${u} posts. Remaining unsynced: ${f}`),await chrome.storage.local.set({[c.STATS]:{totalProfiles:l.size,totalMessages:i.size,totalPosts:d.size,unsyncedProfiles:Array.from(l.values()).filter(a=>!a.syncedAt).length,unsyncedMessages:Array.from(i.values()).filter(a=>!a.syncedAt).length,unsyncedPosts:Array.from(d.values()).filter(a=>!a.syncedAt).length,lastSyncAt:new Date().toISOString(),lastServerSync:new Date().toISOString()}}),{success:!0,profiles:t,messages:o,posts:u}}catch(e){return console.error("[ClaudIn] Sync failed:",e),{success:!1,error:String(e)}}}async function k(){const e={};l.forEach((t,o)=>{e[o]=t});const n={};i.forEach((t,o)=>{n[o]=t});const s={};d.forEach((t,o)=>{s[o]=t}),await chrome.storage.local.set({[c.PROFILES]:e,[c.MESSAGES]:n,[c.POSTS]:s})}E();chrome.runtime.onMessage.addListener((e,n,s)=>{if(e.type==="SYNC_TO_SERVER")return p().then(s),!0});console.log("[ClaudIn] Background script loaded");
