(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))c(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&c(i)}).observe(document,{childList:!0,subtree:!0});function o(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerPolicy&&(s.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?s.credentials="include":e.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function c(e){if(e.ep)return;e.ep=!0;const s=o(e);fetch(e.href,s)}})();const x="http://localhost:3847/api";async function m(){const t=await chrome.storage.local.get(["claudin_profiles","claudin_messages","claudin_posts","claudin_stats"]),n=t.claudin_profiles,o=t.claudin_messages,c=t.claudin_posts,e=t.claudin_stats,s=n?Object.keys(n).length:0,i=o?Object.keys(o).length:0,u=c?Object.keys(c).length:0,l=n?Object.values(n).filter(r=>!r.syncedAt).length:0,a=o?Object.values(o).filter(r=>!r.syncedAt).length:0,d=c?Object.values(c).filter(r=>!r.syncedAt).length:0,g=document.getElementById("profileCount"),p=document.getElementById("messageCount"),S=document.getElementById("postCount"),h=document.getElementById("lastSync"),C=document.getElementById("lastServerSync"),y=document.getElementById("unsyncedSection"),E=document.getElementById("unsyncedCount");g&&(g.textContent=s.toString()),p&&(p.textContent=i.toString()),S&&(S.textContent=u.toString());const f=l+a+d;if(y&&E)if(f>0){y.style.display="block";const r=[];l>0&&r.push(`${l} profile${l>1?"s":""}`),a>0&&r.push(`${a} message${a>1?"s":""}`),d>0&&r.push(`${d} post${d>1?"s":""}`),E.textContent=r.join(", ")}else y.style.display="none";chrome.action.setBadgeText({text:f>0?f.toString():""}),chrome.action.setBadgeBackgroundColor({color:f>0?"#ef4444":"#0A66C2"}),h&&(e!=null&&e.lastSyncAt)&&(h.textContent=B(e.lastSyncAt)),C&&(C.textContent=e!=null&&e.lastServerSync?`Last: ${B(e.lastServerSync)}`:""),await $()}async function $(){try{const t=await fetch(`${x}/enrich/status`);if(!t.ok)return;const{pending:n,processing:o,completed:c,total:e}=await t.json(),s=document.getElementById("queueSection"),i=document.getElementById("queueBadge"),u=document.getElementById("queuePending"),l=document.getElementById("queueProcessing"),a=document.getElementById("queueCompleted");e>0&&s?(s.style.display="block",i&&(i.textContent=(n+o).toString()),u&&(u.textContent=n.toString()),l&&(l.textContent=o.toString()),a&&(a.textContent=c.toString())):s&&(s.style.display="none")}catch{}}function B(t){const n=new Date(t),c=new Date().getTime()-n.getTime(),e=Math.floor(c/(1e3*60));if(e<1)return"Just now";if(e<60)return`${e}m ago`;const s=Math.floor(e/60);return s<24?`${s}h ago`:`${Math.floor(s/24)}d ago`}async function I(){const t=document.getElementById("syncBtn"),n=document.getElementById("syncResult");if(!(!t||!n)){t.disabled=!0,t.textContent="Syncing...",t.classList.add("syncing"),n.className="sync-result";try{const o=await chrome.runtime.sendMessage({type:"SYNC_TO_SERVER"});if(o.success){const c=[];o.profiles&&c.push(`${o.profiles} profiles`),o.messages&&c.push(`${o.messages} messages`),o.posts&&c.push(`${o.posts} posts`),c.length?(n.textContent=`✓ Synced ${c.join(", ")}`,n.className="sync-result success"):(n.textContent="✓ Everything is already synced",n.className="sync-result success")}else n.textContent=`✗ Sync failed: ${o.error||"Server not reachable"}`,n.className="sync-result error"}catch(o){n.textContent=`✗ Error: ${o}`,n.className="sync-result error"}finally{t.disabled=!1,t.textContent="Sync Now",t.classList.remove("syncing"),await m()}}}document.addEventListener("DOMContentLoaded",()=>{m();const t=document.getElementById("syncBtn");t==null||t.addEventListener("click",I)});chrome.storage.onChanged.addListener(t=>{(t.claudin_profiles||t.claudin_messages||t.claudin_posts||t.claudin_stats)&&m()});
